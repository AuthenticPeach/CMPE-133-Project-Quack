<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quack Chat</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
      margin: 0;
      padding: 0;
      position: relative;
      display: flex;
      justify-content: space-between; /* Separate sections */
    }
    #chat-section {
      max-width: 600px;
      margin: 50px auto;
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
      flex-grow: 2; /* Main chat section grows */
    }
    #users-section {
      width: 25%; /* Right third section */
      margin: 50px 20px;
    }
    ul {
      list-style-type: none;
      padding: 0;
    }
    li {
      padding: 8px;
      margin-bottom: 10px;
      background-color: #e0e0e0;
      border-radius: 5px;
    }
    input {
      padding: 10px;
      width: calc(100% - 22px);
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      padding: 10px 20px;
      background-color: #ff5e00;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #signout {
      position: absolute;
      top: 10px;
      right: 10px; /* Move to top-right */
      background-color: #ff0000;
      padding: 10px 20px;
      color: white;
      cursor: pointer;
      border: none;
      border-radius: 5px;
    }
    #links {
      position: absolute;
      top: 10px;
      left: 10px; /* Move links to the top-left */
    }
    #links a {
      margin-right: 20px;
      color: #ff5e00;
      text-decoration: none;
      font-weight: bold;
    }
    #links a:hover {
      text-decoration: underline;
    }
    #emoji-button {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      margin-left: 10px;
      padding: 0 10px;
    }
    #emoji-button:hover {
      color: #ff5e00;
    }
    @media (max-width: 600px) {
      #chat-section {
        margin: 20px;
        padding: 10px;
      }
      input {
        width: calc(100% - 20px);
      }
    }
  </style>
</head>
<body>
  <div id="links"> <!-- Links to profile.html and user-dashboard.html -->
    <a href="/profile.html">Profile</a>
    <a href="/user-dashboard.html">Dashboard</a>
  </div>

  <button id="signout">Sign Out</button> <!-- Sign Out button moved to top-right -->

  <div id="chat-section">
    <h2>Welcome to Quack chat!</h2>
    <ul id="messages"></ul>
    <form id="form">
      <input id="input" autocomplete="off" placeholder="Type a message..." />
      <button id="emoji-button" type="button">ðŸ˜€</button> <!-- Emoji Button -->
      <button type="submit">Send</button>
    </form>
    <p id="typing"></p>
  </div>

  <div id="users-section">
    <h3>Users Online:</h3>
    <ul id="users"></ul> <!-- List of connected users -->
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://unpkg.com/emoji-button@latest"></script>
  <script>
  document.addEventListener('DOMContentLoaded', function() {    
    var socket = io();

    // Extract the username from the URL query parameter
    var urlParams = new URLSearchParams(window.location.search);
    var username = urlParams.get('username');
    var roomName = urlParams.get('room');

    if (!username) {
      // If no username is found, redirect to sign-in page
      window.location.href = '/signin';
    } else {
      // Send the username to the server
      socket.emit('set username', username);

      // Join the specified room
      socket.emit('join room', roomName);
    }

    const input = document.getElementById('input');
    const emojiButton = document.getElementById('emoji-button');

    // Initialize the emoji picker
    const picker = new EmojiButton();
    console.log('Emoji picker initialized');  // Debugging statement

    // Toggle the emoji picker when the button is clicked
    emojiButton.addEventListener('click', () => {
      console.log('Emoji button clicked');  // Debugging statement
      picker.pickerVisible ? picker.hidePicker() : picker.showPicker(emojiButton);
      console.log('EmojiButton:', picker);

    });

    // When an emoji is selected, add it to the input field
    picker.on('emoji', emoji => {
      console.log('Emoji selected:', emoji);  // Debugging statement
      input.value += emoji;
    });

    // Send a message with the username
    var form = document.getElementById('form');

form.addEventListener('submit', function(e) {
  e.preventDefault();
  if (input.value) {
    console.log(`Sending message to room ${roomName}:`, input.value); // Debug log when sending
    socket.emit('chat message', { username: username, message: input.value, roomName: roomName });

    // Place debugging code to verify if the message is sent and received
    console.log("Message emitted to server:", { username: username, message: input.value, roomName: roomName });

    input.value = ''; // Clear the input field
  }
});

socket.on('chat message', function(msg) {
  console.log('Received message:', msg); // Ensure this log shows up
  const item = document.createElement('li');

  // Create profile image element
  const profileImg = document.createElement('img');
  profileImg.src = msg.profilePic || '/uploads/default-avatar.png';
  profileImg.style.width = '40px';
  profileImg.style.height = '40px';
  profileImg.style.borderRadius = '50%';
  profileImg.style.marginRight = '10px';

  // Create text element for the message content
  const text = document.createElement('span');
  text.textContent = `[${msg.timestamp}] ${msg.username}: ${msg.message}`;

  item.appendChild(profileImg);
  item.appendChild(text);

  // If there's an image in the message
  if (msg.image) {
    const chatImage = document.createElement('img');
    chatImage.src = msg.image;
    chatImage.style.maxWidth = '200px';
    chatImage.style.display = 'block';
    item.appendChild(chatImage);
  }

  // Append the message to the messages list
  document.getElementById('messages').appendChild(item);
  window.scrollTo(0, document.body.scrollHeight);
});



// Client-side: Display chat history when joining a room
socket.on('chat history', function(messages) {
  messages.forEach(function(msg) {
    const item = document.createElement('li');

    const profileImg = document.createElement('img');
    profileImg.src = msg.profilePic || '/uploads/default-avatar.png';
    profileImg.style.width = '40px';
    profileImg.style.height = '40px';
    profileImg.style.borderRadius = '50%';
    profileImg.style.marginRight = '10px';

    const text = document.createElement('span');
    text.textContent = `[${new Date(msg.timestamp).toLocaleTimeString()}] ${msg.username}: ${msg.message}`;

    item.appendChild(profileImg);
    item.appendChild(text);

    // If there's an image, display it
    if (msg.image) {
      const chatImage = document.createElement('img');
      chatImage.src = msg.image;
      chatImage.style.maxWidth = '200px';
      chatImage.style.display = 'block';
      item.appendChild(chatImage);
    }

    document.getElementById('messages').appendChild(item);
    window.scrollTo(0, document.body.scrollHeight);
  });
});

// Typing indicator
input.addEventListener('input', function() {
    socket.emit('typing', username);
    });


socket.on('typing', function(username) {
      document.getElementById('typing').textContent = username + ' is typing...';
    });

socket.on('stop typing', function() {
      document.getElementById('typing').textContent = '';
    });

    // Handle Sign Out
    var signoutButton = document.getElementById('signout');
    signoutButton.addEventListener('click', function() {
      socket.disconnect();  // Disconnect the user
      window.location.href = '/signin';  // Redirect to signin page
    });

    // Receive and display the user list
socket.on('user list', function(users) {
      var usersList = document.getElementById('users');
      usersList.innerHTML = '';  // Clear the current list

      users.forEach(function(user) {
        // Create a list item for each user
        var item = document.createElement('li');

        // Create the profile picture element
        const profileImg = document.createElement('img');
        profileImg.src = user.profilePic || '/uploads/default-avatar.png'; // Use default avatar if no profile pic
        profileImg.style.width = '40px';
        profileImg.style.height = '40px';
        profileImg.style.borderRadius = '50%';
        profileImg.style.marginRight = '10px';

        // Create the username element
        const text = document.createElement('span');
        text.textContent = user.username || 'Unknown User'; // Display 'Unknown User' if username is missing

        // Append the profile picture and username to the list item
        item.appendChild(profileImg);
        item.appendChild(text);

        // Append the list item to the users list
        usersList.appendChild(item);
      });
    });

});    
  </script>
</body>
</html>
